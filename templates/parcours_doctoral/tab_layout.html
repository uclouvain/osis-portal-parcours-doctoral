{% extends "layout.html" %}
{% load bootstrap3 i18n static parcours_doctoral doctorate_enums %}

{% comment "License" %}
  * OSIS stands for Open Student Information System. It's an application
  * designed to manage the core business of higher education institutions,
  * such as universities, faculties, institutes and professional schools.
  * The core business involves the administration of students, teachers,
  * courses, programs and so on.
  *
  * Copyright (C) 2015-2023 Université catholique de Louvain (http://www.uclouvain.be)
  *
  * This program is free software: you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation, either version 3 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * A copy of this license - GNU General Public License - is available
  * at the root of the source code of this program.  If not,
  * see http://www.gnu.org/licenses/.
{% endcomment %}

{% comment "Usage" %}
  `tab_layout.html` gère le layout des formulaires et des détails, ceci implique
  - si la variable `form` est présente, le {% block form %} est affiché
  - si dans `form` il y a des `visible_fields`, la balise
  <form> est ajoutée
  ainsi que les boutons de soumission dans les onglets et en bas de page
{% endcomment %}


{% block style %}
  <link href="{% static "parcours_doctoral/parcours_doctoral.css" %}" rel="stylesheet" />
  {% if form %}
    {{ form.media.css }}
  {% endif %}
{% endblock %}

{% block script %}
  {{ block.super }}
  {% if form %}
    {{ form.media.js }}
  {% endif %}
  <script src="{% static 'parcours_doctoral/parcours_doctoral.js' %}"></script>
  <script src="{% static 'parcours_doctoral/popover.js' %}"></script>
{% endblock %}

{% block breadcrumb_area %}
  {% if doctorate and doctorate.matricule_doctorant != user.person.global_id %}
    {% url 'parcours_doctoral:supervised-list' as list_url %}
  {% else %}
    {% url 'parcours_doctoral:list' as list_url %}
  {% endif %}
  <ol class="breadcrumb">
    <li>
      <a href="{{ list_url }}">{% trans "PhDs" %}</a>
    </li>
    {% if doctorate %}
      <li class="active">
        {% block breadcrumb_title %}{{ doctorate.doctorat.intitule }} ({{ doctorate.reference }}){% endblock %}
      </li>
    {% endif %}
  </ol>
{% endblock %}

{% block content %}
  {% trans "Save" context 'doctorate' as save_label %}

  {% if form %}
    {% include "parcours_doctoral/modal/prevent_quitting_modal.html" %}
  {% endif %}

  {% if doctorate and doctorate.matricule_doctorant != user.person.global_id %}
    {% url 'parcours_doctoral:supervised-list' as list_url %}
  {% else %}
    {% url 'parcours_doctoral:list' as list_url %}
  {% endif %}

  {# Header page title #}
  <div class="page-header h3 clearfix">
    <span class="d-inline-block">
      {% block header_title %}{{ doctorate.doctorat.intitule }} ({{ doctorate.reference }}){% endblock %}
    </span>
    {% if user.is_authenticated %}
      <a href="{{ list_url }}" class="pull-right h5 text-primary">
        <span class="fa fa-stream"></span>
        {% trans "Back to PhDs" %}
      </a>
    {% endif %}
  </div>

  {# Well #}
  {% block well %}
    <div class="well">
      <div>
        {% trans "Reference:" %}
        {% display doctorate.doctorat.intitule " (" doctorate.doctorat.campus ")" as doctorate_title %}
        {{ doctorate_title }} ({{ doctorate.reference }})
      </div>
      <div>
        {% trans "Status:" %}
        {{ doctorate.statut|enum_display:'ChoixStatutDoctorat' }}
      </div>
    </div>
  {% endblock well %}

  {% block template_messages %}
    <div id="template-messages-container">
      {% include "template_messages.html" %}
    </div>
  {% endblock %}

  {% url "parcours_doctoral:"|add:request.resolver_match.url_name view.kwargs.pk as cancel_url %}
  {% url "parcours_doctoral:update:"|add:request.resolver_match.url_name view.kwargs.pk as change_url %}

  {% block tabs_content %}
    {% get_current_tab as current_tab %}

    {% if form.visible_fields %}
    {% elif change_url and change_url != request.path and doctorate|can_update_tab:current_tab %}
      {# Display the edit button if accessible #}
      <div class="text-right visible-xs visible-sm">
        <a href="{{ change_url }}" class="btn btn-primary">
          <span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span>
          {% trans 'Edit' %}
        </a>
      </div>
    {% endif %}

    {% current_subtabs as subtabs %}

    {% doctorate_tabs doctorate with_submit=form.visible_fields %}

    {% if subtabs|length > 1 %}
      {# If there are multiple subtabs, display them on the side #}
      <div id="subtabs-row" class="row">
      <div id="subtabs" class="col-md-2 visible-md visible-lg">
        {% get_current_parent_tab as current_parent %}
        <div id="subtab-current-parent">{{ current_parent.label }}</div>
        <hr>
        {% doctorate_subtabs doctorate %}
      </div>
    {% endif %}

  <div class="{% if subtabs|length > 1 %}col-md-10 {% endif %}{% if form %}quitting-context-excluded{% endif %}">
    {% block tab_content %}
      {% if form.visible_fields %}
        <form id="doctorate-main-form" class="osis-form" method="post" action="">
          {# Form and form buttons #}
          {% csrf_token %}
          {% block form %}{% endblock %}
          {% block submit_button_bottom %}
            {% get_current_tab as current_tab %}
            <div class="text-right form-group">
              {% block submit_button %}
                <button
                  type="submit" class="{{ submit_class|default:'btn btn-default' }}"
                  {% if cancel_url and not doctorate|can_update_tab:current_tab %}
                  disabled
                  {% endif %}
                  form="doctorate-main-form"
                >
                  <i class="fa-solid {{ submit_icon|default:'fa-floppy-disk' }}"></i>
                  {{ submit_label|default:save_label }}
                </button>
              {% endblock submit_button %}
            </div>
          {% endblock submit_button_bottom %}
        </form>
        {% block after_form %}{% endblock %}
      {% endif %}
    {% endblock %}
  </div>
  {% if subtabs|length > 1 %}
    {# End sibling tabs #}
    </div>
  {% endif %}
  {% endblock tabs_content %}
  {% block extra_content %}{% endblock %}
{% endblock %}

{% block footer %}
  {% include "parcours_doctoral/includes/footer.html" %}
  {{ block.super }}
{% endblock %}
